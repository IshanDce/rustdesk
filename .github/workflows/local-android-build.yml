name: Local Android Build

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build from'
        required: false
        default: 'master'

jobs:
  build-android:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: "3.24.5"

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: "r27c"
          add-to-path: true

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: "1.75"

      - name: Install cargo-ndk
        run: cargo install cargo-ndk --version 3.1.2 --locked

      - name: Add Android targets
        run: |
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi
          rustup target add x86_64-linux-android
          rustup target add i686-linux-android

      - name: Build Rust libraries
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          cd flutter
          ./ndk_arm64.sh
          ./ndk_arm.sh
          ./ndk_x64.sh
          ./ndk_x86.sh

      - name: Copy libraries to JNI
        run: |
          mkdir -p flutter/android/app/src/main/jniLibs/arm64-v8a
          mkdir -p flutter/android/app/src/main/jniLibs/armeabi-v7a
          mkdir -p flutter/android/app/src/main/jniLibs/x86_64
          mkdir -p flutter/android/app/src/main/jniLibs/x86

          cp target/aarch64-linux-android/release/liblibrustdesk.so flutter/android/app/src/main/jniLibs/arm64-v8a/librustdesk.so
          cp target/armv7-linux-androideabi/release/liblibrustdesk.so flutter/android/app/src/main/jniLibs/armeabi-v7a/librustdesk.so
          cp target/x86_64-linux-android/release/liblibrustdesk.so flutter/android/app/src/main/jniLibs/x86_64/librustdesk.so
          cp target/i686-linux-android/release/liblibrustdesk.so flutter/android/app/src/main/jniLibs/x86/librustdesk.so

      - name: Build Android APK
        run: |
          cd flutter
          flutter build apk --release

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-android-apk
          path: flutter/build/app/outputs/flutter-apk/app-release.apk